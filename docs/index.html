<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LONGARC — Filtered Screener</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#121a33; --fg:#e9eefc; --muted:#9fb0da;
      --line:#263155; --chip:#1b2750; --accent:#7aa2ff;
    }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(180deg,#070a14, #0b1020 30%, #070a14);
      color:var(--fg);
    }
    .wrap{max-width:1200px;margin:28px auto;padding:0 16px;}
    h1{margin:0 0 6px 0;font-size:22px;letter-spacing:.4px}
    .muted{color:var(--muted);font-size:13px}
    .bar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin:14px 0 12px 0;
    }
    input[type="search"]{
      flex:1; min-width:260px;
      padding:10px 12px; border-radius:12px;
      border:1px solid var(--line); background:var(--panel); color:var(--fg);
      outline:none;
    }
    .chip{
      padding:8px 10px; border:1px solid var(--line); background:var(--chip);
      border-radius:999px; font-size:12px; color:var(--muted);
      display:inline-flex; gap:8px; align-items:center;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    .card{
      background:rgba(18,26,51,.85);
      border:1px solid var(--line); border-radius:16px;
      overflow:hidden;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    table{width:100%; border-collapse:separate; border-spacing:0}
    thead th{
      position:sticky; top:0;
      background:rgba(18,26,51,.98);
      border-bottom:1px solid var(--line);
      padding:10px 10px;
      font-size:12px; color:var(--muted);
      text-align:left;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    thead th .arrow{opacity:.6; margin-left:6px}
    tbody td{
      border-bottom:1px solid rgba(38,49,85,.7);
      padding:10px 10px;
      font-size:13px;
      vertical-align:top;
    }
    tbody tr:nth-child(2n){background:rgba(9,13,28,.35)}
    code{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      padding:2px 6px;border-radius:8px;font-size:12px
    }
    .status{margin:10px 0 0 0}
    .small{font-size:12px;color:var(--muted)}
    .right{margin-left:auto}
    .btn{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(27,39,80,.65);
      color:var(--fg);
    }
    .btn:hover{background:rgba(27,39,80,.95)}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>LONGARC — Filtered Screener</h1>
    <div class="muted">
      Static viewer for a CSV in your repo. Tip: add <code>?csv=outputs/yourfile.csv</code> to view a different run.
    </div>

    <div class="bar">
      <input id="q" type="search" placeholder="Search tickers, sectors, industries, anything…" />
      <span class="chip" id="meta">Loading…</span>
      <a class="btn right" id="csvLink" href="#" target="_blank" rel="noopener">Open CSV</a>
    </div>

    <div class="card">
      <table id="tbl">
        <thead><tr id="hdr"></tr></thead>
        <tbody id="body"></tbody>
      </table>
    </div>

    <div class="status small" id="status"></div>
  </div>

<script>
  // ---- Config: default CSV path (edit this to match your repo layout if needed) ----
  const DEFAULT_CSV = "https://raw.githubusercontent.com/aglucaci/longarc/refs/heads/main/outputs/longarc_filtered_TODAY.csv";

  // ---- Basic CSV parser (handles quotes, commas, and newlines in quoted fields) ----
  function parseCSV(text) {
    const rows = [];
    let row = [];
    let i = 0, field = "", inQuotes = false;

    while (i < text.length) {
      const c = text[i];

      if (inQuotes) {
        if (c === '"') {
          const next = text[i + 1];
          if (next === '"') { field += '"'; i += 2; continue; }
          inQuotes = false; i++; continue;
        } else {
          field += c; i++; continue;
        }
      } else {
        if (c === '"') { inQuotes = true; i++; continue; }
        if (c === ',') { row.push(field); field = ""; i++; continue; }
        if (c === '\r') { i++; continue; }
        if (c === '\n') {
          row.push(field); rows.push(row);
          row = []; field = ""; i++; continue;
        }
        field += c; i++; continue;
      }
    }
    // last field/row
    if (field.length > 0 || row.length > 0) { row.push(field); rows.push(row); }
    // remove empty trailing rows
    while (rows.length && rows[rows.length - 1].every(x => (x ?? "").trim() === "")) rows.pop();
    return rows;
  }

  function getCsvPath() {
    const u = new URL(window.location.href);
    return u.searchParams.get("csv") || DEFAULT_CSV;
  }

  function isNumericLike(x) {
    if (x == null) return false;
    const s = String(x).trim();
    if (s === "") return false;
    // allow percent, commas
    const t = s.replace(/[%,$]/g, "").replace(/,/g, "");
    return t !== "" && !isNaN(Number(t));
  }

  function toNumberSmart(x) {
    const s = String(x ?? "").trim().replace(/[%,$]/g, "").replace(/,/g, "");
    const v = Number(s);
    return isNaN(v) ? null : v;
  }

  function makeLinkIfUrl(val) {
    const s = String(val ?? "").trim();
    if (/^https?:\/\//i.test(s)) {
      const a = document.createElement("a");
      a.href = s;
      a.target = "_blank";
      a.rel = "noopener";
      a.textContent = s;
      return a;
    }
    return document.createTextNode(s);
  }

  let headers = [];
  let data = [];
  let filtered = [];
  let sortState = { col: null, dir: 1 };

  function renderTable(rows) {
    const tbody = document.getElementById("body");
    tbody.innerHTML = "";

    for (const r of rows) {
      const tr = document.createElement("tr");
      for (let c = 0; c < headers.length; c++) {
        const td = document.createElement("td");
        const v = r[headers[c]];
        // Make URLs clickable
        td.appendChild(makeLinkIfUrl(v));
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }

    document.getElementById("meta").textContent =
      `${rows.length.toLocaleString()} rows • ${headers.length} cols`;
  }

  function renderHeader() {
    const hdr = document.getElementById("hdr");
    hdr.innerHTML = "";

    headers.forEach((h, idx) => {
      const th = document.createElement("th");
      th.textContent = h;
      const arrow = document.createElement("span");
      arrow.className = "arrow";
      arrow.textContent = (sortState.col === h) ? (sortState.dir === 1 ? "▲" : "▼") : "↕";
      th.appendChild(arrow);

      th.addEventListener("click", () => {
        if (sortState.col === h) sortState.dir *= -1;
        else { sortState.col = h; sortState.dir = 1; }

        const dir = sortState.dir;
        const col = sortState.col;

        const numeric = filtered.some(r => isNumericLike(r[col]));
        filtered.sort((a,b) => {
          const av = a[col], bv = b[col];
          if (numeric) {
            const an = toNumberSmart(av), bn = toNumberSmart(bv);
            if (an == null && bn == null) return 0;
            if (an == null) return 1;
            if (bn == null) return -1;
            return dir * (an - bn);
          } else {
            const as = String(av ?? "").toLowerCase();
            const bs = String(bv ?? "").toLowerCase();
            if (as < bs) return -dir;
            if (as > bs) return dir;
            return 0;
          }
        });

        renderHeader();
        renderTable(filtered);
      });

      hdr.appendChild(th);
    });
  }

  function applySearch() {
    const q = document.getElementById("q").value.trim().toLowerCase();
    if (!q) {
      filtered = data.slice();
    } else {
      filtered = data.filter(r => {
        return headers.some(h => String(r[h] ?? "").toLowerCase().includes(q));
      });
    }
    // keep sort if set
    if (sortState.col) {
      const col = sortState.col;
      const dir = sortState.dir;
      const numeric = filtered.some(r => isNumericLike(r[col]));
      filtered.sort((a,b) => {
        const av = a[col], bv = b[col];
        if (numeric) {
          const an = toNumberSmart(av), bn = toNumberSmart(bv);
          if (an == null && bn == null) return 0;
          if (an == null) return 1;
          if (bn == null) return -1;
          return dir * (an - bn);
        } else {
          const as = String(av ?? "").toLowerCase();
          const bs = String(bv ?? "").toLowerCase();
          if (as < bs) return -dir;
          if (as > bs) return dir;
          return 0;
        }
      });
    }
    renderTable(filtered);
  }

  async function load() {
    const csvPath = getCsvPath();
    document.getElementById("csvLink").href = csvPath;

    const status = document.getElementById("status");
    status.textContent = `Loading: ${csvPath}`;

    try {
      // IMPORTANT: this requires the file to be served (GitHub Pages, or local server).
      const res = await fetch(csvPath, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status} — ${res.statusText}`);
      const text = await res.text();

      const rows = parseCSV(text);
      if (!rows.length) throw new Error("CSV appears empty.");

      headers = rows[0].map(x => String(x || "").trim());
      data = rows.slice(1).map(cols => {
        const obj = {};
        headers.forEach((h, i) => obj[h] = cols[i] ?? "");
        return obj;
      });

      filtered = data.slice();
      sortState = { col: null, dir: 1 };

      renderHeader();
      renderTable(filtered);

      status.textContent = `Loaded ${data.length.toLocaleString()} rows from ${csvPath}. Click a column header to sort.`;
    } catch (err) {
      console.error(err);
      status.innerHTML = `❌ Failed to load CSV. <br/>
        <span class="small">
          This page must be served over HTTP (e.g., GitHub Pages). If you open it as a local file, <code>fetch()</code> may be blocked.
          Error: <code>${String(err.message || err)}</code>
        </span>`;
      document.getElementById("meta").textContent = "Load failed";
    }
  }

  document.getElementById("q").addEventListener("input", applySearch);
  load();
</script>
</body>
</html>
